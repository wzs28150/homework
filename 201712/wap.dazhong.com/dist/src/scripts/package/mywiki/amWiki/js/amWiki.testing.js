!function(e,t){"use strict";var a=function(){this.$e={win:t(e),testingBox:t("#testingBox"),view:t("#view"),sibling:t("#mainSibling"),testingShow:null,testingParam:t("#testingParam")},this._data={globalParams:[],globalParamWorking:!0,paramTemplate:t("#template\\:formList").text()},this._request={url:"",method:"",params:[],paramGlobal:[]},this._useGlobalParam(),this._bindPanelCtrl(),this._bindAjaxSend()};return a.prototype.crawlContent=function(){var e=this,a=[!1,!1,!1];this.$e.testingShow.removeClass("show"),this.$e.view.find("h3").each(function(){var s=t(this),i=t.trim(s.text());if("请求地址"!=i||a[0])if("请求类型"!=i||a[1])"请求参数"!=i||a[2]||(e._request.params.length=0,s.next("table").length>0&&s.next("table").find("tbody").find("tr").each(function(){var a=t(this).find("td"),s={keyName:a.eq(0).text().replace(/^\s+|\s+$/g,""),valueType:a.eq(1).text().replace(/^\s+|\s+$/g,""),required:a.eq(2).text().replace(/^\s+|\s+$/g,""),describe:a.eq(3).text().replace(/^\s+|\s+$/g,""),default:a.eq(4).text().replace(/^\s+|\s+$/g,""),reference:a.eq(5).text().replace(/^\s+|\s+$/g,"")};"无"!=s.keyName&&"-"!=s.keyName&&""!=s.keyName&&("是"==s.required||"必填"==s.required||"yes"==s.required||"true"==s.required?s.required="required":s.required="","-"!=s.default&&"无"!=s.default&&"Null"!=s.default&&"null"!=s.default||(s.reference&&"-"!=s.reference&&"无"!=s.reference&&"Null"!=s.reference&&"null"!=s.reference?s.default=s.reference:s.default=""),e._request.params.push(s))}),a[2]=!0);else{e._request.method=t.trim(s.next().text()).toUpperCase();var n=!1;["GET","POST","PUT","DELETE"].forEach(function(t,a){e._request.method==t&&(n=!0)}),n||(e._request.method="POST"),a[1]=!0}else e._request.url=t.trim(s.next().text()),e._request.url.indexOf("http")<0&&(0==e._request.url.indexOf("/")?e._request.url="http://"+location.host+e._request.url:e._request.url="http://"+location.host+"/"+e._request.url),a[0]=!0}),a[0]&&a[1]&&a[2]?this._initPanel():this._offPanel(),a=[!1,!1,!1]},a.prototype._offPanel=function(){this.$e.testingShow.removeClass("show"),this.$e.testingShow.hasClass("on")&&this.displayBox("off"),this._request.url="",this._request.method="",this._request.params=[],t("#testingSendUrl").val(""),t("#testingSendType").find('option[value="POST"]').prop("selected",!0),this.$e.testingParam.html(""),t("#testingResponse")[0].contentWindow.location.reload()},a.prototype._initPanel=function(){if(this.$e.testingShow.addClass("show"),t("#testingSendUrl").val(this._request.url),t("#testingSendType").find('option[value="'+this._request.method+'"]').prop("selected",!0),this.$e.testingParam.html(""),this._request.params.length>0){for(var e="",a=0;a<this._request.params.length;a++)e+=this._data.paramTemplate.replace("{{describe}}",this._request.params[a].describe).replace("{{keyName}}",this._request.params[a].keyName).replace("{{default}}",this._request.params[a].default).replace("{{valueType}}",this._request.params[a].valueType).replace("{{required}}",this._request.params[a].required);this.$e.testingParam.append(e)}else this.$e.testingParam.append("<li>无</li>")},a.prototype.displayBox=function(e){var t=this;"off"==e?(this.$e.testingShow.removeClass("on").find("span").text("测试接口"),this.$e.testingBox.css({position:"absolute"}),this.$e.view.show().addClass("scroller-content"),this.$e.sibling.addClass("scroller-content").addClass("on"),this.$e.testingBox.removeClass("scroller-content").stop().animate({width:"30%",opacity:0},200,"swing",function(){t.$e.testingBox.removeAttr("style")})):"on"==e&&(this.$e.testingShow.addClass("on").find("span").text("关闭测试"),this.$e.testingBox.css({display:"block",width:"0",opacity:0}).stop().animate({width:"100%",opacity:1},300,"swing",function(){t.$e.view.hide().removeClass("scroller-content"),t.$e.sibling.removeClass("scroller-content").removeClass("on"),t.$e.testingBox.addClass("scroller-content").css({position:"relative"})}))},a.prototype._bindPanelCtrl=function(){var e=this;this.$e.testingShow=t('<div class="testing-show">[<span>测试接口</span>]</div>'),"file:"==location.protocol&&this.$e.testingShow.attr("disabled","disabled").append("<i>您当前为本地模式打开，file:// 协议下不开放接口测试模块，请使用 http(s):// 网址打开</i>"),t("#main").append(this.$e.testingShow),this.$e.testingShow.on("click",function(){var t=e.$e.testingShow;"disabled"==t.attr("disabled")?t.toggleClass("on"):e.$e.testingShow.hasClass("on")?e.displayBox("off"):e.displayBox("on")}),t("#testingSendUrl").on("change",function(){e._request.url=t(this).val()}),t("#testingSendType").on("change",function(){e._request.method=t(this).find("option:selected").val()}),t("#testingBtnReset").on("click",function(){e.$e.testingParam.find(".testing-param-val").val("")}),t("#testingBtnAdd").on("click",function(){var t=e._data.paramTemplate.replace("{{describe}}","新增参数").replace("{{keyName}}","").replace("{{default}}","").replace("({{valueType}})","").replace("{{required}}","");e.$e.testingParam.append(t)})},a.prototype._useGlobalParam=function(){var e=this;this._data.globalParams=JSON.parse(localStorage.amWikiGlobalParam||"[]");var a=t("#template\\:globalParam").text(),s=t("#testingGlobalParam"),i=t("#testingGlobal");this._data.globalParamWorking="on"==(localStorage.amWikiGParamWorking||"on"),t("#testingBtnGParam").on("click",function(){if(s.html(""),e._data.globalParams=JSON.parse(localStorage.amWikiGlobalParam||"[]"),0==e._data.globalParams.length)s.append('<li data-type="empty">无</li>');else for(var t=0;t<e._data.globalParams.length;t++)s.append(a.replace("{{describe}}",e._data.globalParams[t].describe).replace("{{keyName}}",e._data.globalParams[t].keyName).replace("{{value}}",e._data.globalParams[t].value));i.show()}),i.on("click",function(n){var r=t(n.target);r.hasClass("close")||r.hasClass("testing-global")?i.hide():r.hasClass("add")?(s.find('[data-type="empty"]').remove(),s.append(a.replace("{{describe}}","").replace("{{keyName}}","").replace("{{value}}",""))):r.hasClass("save")&&(e._data.globalParams.length=0,s.find("li").each(function(a,s){var i=t(this).find("input");i.eq(1).val()&&e._data.globalParams.push({describe:i.eq(0).val(),keyName:i.eq(1).val(),value:i.eq(2).val()})}),localStorage.amWikiGlobalParam=JSON.stringify(e._data.globalParams),i.hide())}),s.on("click","i",function(){t(this).parent().remove(),0==s.find("li").length&&s.append('<li data-type="empty">无</li>')}),t("#testingGlobalWorking").on("click",function(){e._data.globalParamWorking?(e._data.globalParamWorking=!1,localStorage.amWikiGParamWorking="off",t(this).addClass("off")):(e._data.globalParamWorking=!0,localStorage.amWikiGParamWorking="on",t(this).removeClass("off"))}).addClass(this._data.globalParamWorking?"":"off")},a.prototype._bindAjaxSend=function(){var a=this,s=t("#testingResponse")[0],i=t("#testingDuration"),n=t("#testingLoading"),r=t("#testingParam");t("#testingBtnSend").on("click",function(){i.text("");var l={};if(r.find("input").length>0&&r.find("li").each(function(){var e=t(this);l[e.find(".testing-param-key").val()]=e.find(".testing-param-val").val()}),a._data.globalParams.length>0&&a._data.globalParamWorking)for(var o=0;o<a._data.globalParams.length;o++)l[a._data.globalParams[o].keyName]=a._data.globalParams[o].value;s.contentWindow.location.reload(),n.show();var d=Date.now();t.ajax({type:a._request.method,url:a._request.url,data:l,dataType:"text",success:function(a){n.hide(),i.text("耗时："+parseFloat(Date.now()-d).toLocaleString()+" ms");var r=t(s.contentWindow.document).find("body");r.css("wordBreak","break-all"),/^\s*\{[\s\S]*\}\s*$/.test(a)?(r[0].innerHTML='<pre style="white-space:pre-wrap;word-break:break-all;"><pre>',r.find("pre").text(e.tools.formatJson(a))):r[0].innerHTML=a.replace(/<!(doctype|DOCTYPE)\s+(html|HTML)>/,""),setTimeout(function(){t(s).height(r.height())},100)},error:function(a,r){n.hide(),i.text("耗时："+parseFloat(Date.now()-d).toLocaleString()+" ms");var l=t(s.contentWindow.document).find("body");l.css("wordBreak","break-all");var o='<div style="margin-bottom:20px;padding:10px;background:#ffebe5;">HTTP Status: <b>'+a.status+"</b> "+a.statusText+"</div>";0==a.readyState?(o+='<div style="font-size:14px;">请求未发送！可能是因为：<ul style="line-height:22px;"><li>请求了<b style="color:#FF201E;margin-right:1px;">跨域</b>地址</li><li>接口被302重定向到跨域地址</li><li>其他原因</li></ul></div>',l[0].innerHTML=o):/^\s*\{[\s\S]*\}\s*$/.test(a.responseText)?(o+='<pre style="white-space:pre-wrap;word-break:break-all;"><pre>',l[0].innerHTML=o,l.find("pre").text(e.tools.formatJson(a.responseText))):(o+=a.responseText.replace(/<!(doctype|DOCTYPE)\s+(html|HTML)>/,""),l[0].innerHTML=o),setTimeout(function(){t(s).height(l.height())},100)}})})},a.prototype.isOpen=function(){return this.$e.testingShow.hasClass("on")},e.AWTesting=a}(window,jQuery);