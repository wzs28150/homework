/**
 * amWiki Web端 - 入口模块
 * @author Tevin
 * @see {@link https://github.com/TevinLi/amWiki}
 * @license MIT - Released under the MIT license.
 */

$(function(){"use strict";var e=window.tools,n=new AWDocs,t=new AWStorage,a=new AWSearch(t);if(window.AWTesting)var o=new AWTesting;var s="pushState"in history,r=$(window),i=($("body"),$("#menuIcon")),l=$("#container"),c=$("#nav"),f=$("#menuBar"),h=$("#menuFilter"),d=h.next("i"),u=$("#main"),v=u.children(".main-inner"),g=$("#mainSibling"),p=$("#contents"),m=window.isMobi=function(){var e=r.width(),n=720,t=function(){e=r.width(),e<=n?l.removeAttr("style"):l.height(r.height()-70-15-40)};return t(),r.on("resize",t),function(){return e<=n}}();!function(){f.on("click","h4",function(){var e=$(this);e.hasClass("on")||(e.addClass("on"),f.find("a").removeClass("on")),f.find("h5").removeClass("on").next("ul").hide()}),f.on("click","h5",function(){var e=$(this),n=e.next("ul");e.hasClass("on")?(e.removeClass("on"),n.slideUp(200,function(){f.trigger("scrollbar")})):(e.addClass("on"),n.slideDown(200,function(){f.trigger("scrollbar")}))}),f.on("click","strong",function(){var e=$(this),n=e.next("ul");e.hasClass("on")?(e.removeClass("on"),n.slideUp(200,function(){f.trigger("scrollbar")})):(e.addClass("on"),n.slideDown(200,function(){f.trigger("scrollbar")}))}),i.on("click",function(){var e=$(this);e.hasClass("close")?(e.removeClass("close").find("use").attr("xlink:href","#icon:navStart"),c.removeClass("on")):(e.addClass("close").find("use").attr("xlink:href","#icon:navClose"),c.addClass("on"))}),c.on("navchange searchon searchoff",function(e){i.removeClass("close").find("use").attr("xlink:href","#icon:navStart"),c.removeClass("on")}),h.on("input propertychange input2",function(){var e=h.val().replace(/([\(\)\[\]\^\$\+])/g,"\\$1"),n=new RegExp("("+$.trim(h.val()).split(/[ ,]/).join("|")+")","ig");""==e||/^\s$/g.test(e)?(d.addClass("off"),f.find("h5").each(function(){C("open",null,$(this))}),t.setStates("navFilterKey")):(d.removeClass("off"),f.find("h5").each(function(){C("filter",n,$(this))}),t.setStates("navFilterKey",e)),f.trigger("scrollbar")}),d.on("click",function(){h.val("").trigger("input2")}),sessionStorage.AMWikiIconsSvg?$("#svgSymbols").append(sessionStorage.AMWikiIconsSvg):$.get("amWiki/images/icons.svg",function(e){sessionStorage.AMWikiIconsSvg=e,$("#svgSymbols").append(e)},"text").fail(function(){"undefined"!=typeof AWPageMounts&&(sessionStorage.AMWikiIconsSvg=AWPageMounts.icon.content,$("#svgSymbols").append(AWPageMounts.icon.content))}),p.children(".btn").on("click",function(e){p.toggleClass("on").removeClass("hover")}),p.hover(function(){p.addClass("hover")},function(){p.removeClass("hover")}),$(".scroller").scrollbar(),$("#backTop").on("click",function(){v.scrollTop(0)}),u.imgsView(),$(document).on("click",function(e){var n=$(e.target);m()&&0==n.closest("#contents").length&&p.removeClass("on").removeClass("on")})}();var C=function(e,n,t){var a=t.next("ul"),o=t.find("span");"filter"==e&&n?n.test(o.text())?(o.html(o.text().replace(n,"<mark>$1</mark>")),t.addClass("on").removeClass("off"),a.show().find("> li > a").each(function(){var e=$(this),t=e.find("span");t.html(t.text().replace(n,"<mark>$1</mark>")),e.parent().removeClass("off")}),x(t),a.find("> li > strong").each(function(){C("open",n,$(this))})):(o.text(o.text()),t.removeClass("on"),t.is("h5")?t.parent().addClass("off"):t.addClass("off"),a.hide().find("> li > a").each(function(){var e=$(this),t=e.find("span");n.test(e.text())?(t.html(t.text().replace(n,"<mark>$1</mark>")),e.parent().removeClass("off"),x(a.show().prev())):(t.text(t.text()),e.parent().addClass("off"))}),a.find("> li > strong").each(function(){C("filter",n,$(this))})):"open"==e&&(t.removeClass("off"),t.hasClass("on")?a.show():a.hide(),n?(o.html(o.text().replace(n,"<mark>$1</mark>")),n.test(o.text())&&a.show(),a.find("> li > a").each(function(){var e=$(this),t=e.find("span");t.html(t.text().replace(n,"<mark>$1</mark>")),n.test(e.text())&&a.show(),e.parent().removeClass("off")}),x(t),a.find("> li > strong").each(function(){C("open",n,$(this))})):(o.text(o.text()),a.find("> li > a").each(function(){var e=$(this).find("span");e.text(e.text())}),a.children("li").removeClass("off").children("strong").each(function(){C("open",null,$(this))})))},x=function(e){if(e.addClass("on").removeClass("off"),!e.is("h5")){var n=e.parent().removeClass("off").parent().show().prev();x(n)}},k=function(e){if(!e)return void g.removeClass("on");var n=function(e,t){var a=t[e]();return 0==a.length?null:a.children("ul").length>0?n(e,a):a.children("a")},t=function(e,n){n?g.find("a").eq(e).attr("href",n.attr("href")).text(n.text()):g.find("a").eq(e).removeAttr("href").text("没有了")};t(0,n("prev",e)),t(1,n("next",e)),o&&!o.isOpen()&&g.addClass("on")},w=function(e){if(/^home[-_].*?/.test(e)||"首页"==e)f.find("h4").addClass("on"),f.find("a").removeClass("on"),k(null);else{var n=!1;f.find("a").each(function(){var t=$(this),a=t.attr("href").split("file=")[1];if(a==e){n=!0;var o=t.addClass("on").parent().parent().show().prev().addClass("on");x(o),k(t.parent())}else t.removeClass("on")}),n&&f.find("h4").removeClass("on")}S=e,f.trigger("scrollbar")},A=function(){n.loadPage(b.path,function(e,a){"success"==e&&(w(b.path),n.renderDoc(a),t.saveDoc(b.path,a),u.trigger("scrollbar"))}),s&&history.replaceState({path:b.path},"",b.url)},W=function(e,a,r){var i=t.read(e);if(n.renderDoc(i),o&&o.crawlContent(),u.trigger("scrollbar"),v.scrollTop(0),!a&&s){var l=e.replace(/&/g,"%26");history.pushState({path:e},"","?file="+l)}n.loadPage(e,function(a,s){"error"==a?""==i?A():(t.increaseOpenedCount(e),r&&r()):"success"==a&&(s!=i&&(n.renderDoc(s),t.saveDoc(e,s),o&&o.crawlContent(),u.trigger("scrollbar")),t.increaseOpenedCount(e),r&&r())})},b={},P=function(e){var n=function(n){f.find(".scroller-content").html(marked(n));var o=f.find("h4");b.text=o.text(),b.url=o.find("a").attr("href"),b.path=b.url.split("file=")[1],o.prepend('<svg><use xlink:href="#icon:navHome"></use></svg>'),f.find("h5").each(function(){var e=$(this);e.html('<svg><use xlink:href="#icon:navArrow"></use></svg><span>'+e.text()+"</span>")}),f.trigger("scrollbar");var r=[];f.find("a").each(function(){var e=$(this);if(e.html("<span>"+e.text()+"</span>"),s){var n=e.attr("href").split("file=")[1];r.push(n),e.on("click",function(){return a.displayBox("off"),w(n),W(n),e.trigger("navchange"),!1})}}),g.find("a").on("click",function(){if(s){var e=$(this),n=e.attr("href");if("undefined"!=typeof n&&""!=n){var t=n.split("file=")[1];w(t),W(t),e.trigger("navchange")}return!1}}),f.find("strong").each(function(){var e=$(this);e.html("<span>"+e.text()+"</span>")}),$("#results").on("click","a",function(){if(s){var e=$(this),n=e.attr("href");if("undefined"!=typeof n&&""!=n){var t=n.split("file=")[1];a.displayBox("off"),w(t),W(t),e.trigger("navchange")}return!1}});var i=t.getStates("navFilterKey");"undefined"!=typeof i&&""!=i&&h.val(i).trigger("input2"),e&&e(r)};$.get("library/$navigation.md?t="+Date.now(),n,"text").fail(function(){"undefined"!=typeof AWPageMounts&&n(AWPageMounts.nav.content)})},y=function(){if("undefined"!=typeof AWPageMounts){var e=AWPageMounts.home.name.replace(/\.md$/,""),n=t.readTime(e);if(AWPageMounts.home.timestamp>n){t.saveDoc(e,AWPageMounts.home.content),delete AWPageMounts.home;for(var a in AWPageMounts)if(AWPageMounts.hasOwnProperty(a)&&/^m\d+/.test(a)){for(var o,s=0;o=AWPageMounts[a][s];s++)t.saveDoc(o.path.replace(/\.md$/,""),o.content);delete AWPageMounts[a]}t.saveRebuild()}else{delete AWPageMounts.home;for(var r in AWPageMounts)AWPageMounts.hasOwnProperty(r)&&/^m\d+/.test(r)&&delete AWPageMounts[r]}}},M=function(){var e=location.hash.split("#")[1];if(!e||""==e.length)return void(0!=v.scrollTop()&&v.scrollTop(0));var n=$('.anchor[name="'+e+'"]');0!=n.length&&v.scrollTop(n.position().top+v.scrollTop()-10)},S=e.getURLParameter("file");S=S?decodeURI(S):"首页",S=S.replace(/%26/g,"&"),P(function(e){t.checkLibChange(e),y(),w(S),W(S,!0,M)}),s&&r.on("popstate",function(n){var t;n.originalEvent.state?(t=n.originalEvent.state.path,t=t.replace(/%26/g,"&"),w(t),W(t,!0,M)):(t=e.getURLParameter("file"),t=t?decodeURI(t):"首页",t=t.replace(/%26/g,"&"),t!=S?(w(t),W(t,!0,M)):M())}),a.onNeedRebuildStorage=function(e){t.clearLibraries();for(var a,o=t.getIndexList(),s=0,r=function(a,r){setTimeout(function(){n.loadPage(a,function(n,r){"success"==n&&t.saveDocToDB(a,r),++s>=o.length&&(t.saveRebuild(),e&&e())})},100*r)},i=0;a=o[i];i++)r(a,i)}});